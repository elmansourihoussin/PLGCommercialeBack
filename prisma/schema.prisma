generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  ADMIN
  AGENT
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

enum PlatformRole {
  ROOT
  ADMIN
}

enum NotificationType {
  INVOICE_DUE_SOON
  INVOICE_OVERDUE
  PAYMENT_RECEIVED
  PAYMENT_PARTIAL
  QUOTE_ACCEPTED
  QUOTE_REJECTED
  QUOTE_EXPIRED
  STOCK_LOW
  CHEQUE_DUE
  CHEQUE_CASHED
  CHEQUE_REJECTED
  USER_DEACTIVATED
  USER_ACTIVATED
  SUBSCRIPTION_ISSUE
}

model Tenant {
  id             String               @id @default(uuid())
  name           String
  ice            String?
  logoUrl        String?
  phone          String?
  address        String?
  city           String?
  email          String?
  legalMentions  String?
  isActive       Boolean              @default(true)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  deletedAt      DateTime?

  users          User[]
  clients        Client[]
  quotes         Quote[]
  invoices       Invoice[]
  cheques        Cheque[]
  invoicePayments InvoicePayment[]
  articles       Article[]
  billingHistory BillingSubscriptionHistory[]
  subscription   BillingSubscription?
  notifications  Notification[]
}

model User {
  id                     String    @id @default(uuid())
  tenantId               String
  tenant                 Tenant    @relation(fields: [tenantId], references: [id])
  email                  String    @unique
  passwordHash           String
  fullName               String
  role                   UserRole
  isActive               Boolean   @default(true)
  refreshTokenHash       String?
  passwordResetToken     String?
  passwordResetExpiresAt DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  deletedAt              DateTime?

  notifications          Notification[]

  @@index([tenantId])
}

model PlatformUser {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String
  role         PlatformRole
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?
}

model Client {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  ice       String?
  email     String?
  phone     String?
  address   String?
  city      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  quotes    Quote[]
  invoices  Invoice[]
  cheques   Cheque[]

  @@index([tenantId])
}

model Article {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  sku       String?
  description String?
  unitPrice Decimal  @db.Decimal(12, 2)
  taxRate   Decimal? @db.Decimal(5, 4)
  stockQty  Int      @default(0)
  unit      String?
  isService Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  invoiceLines InvoiceLine[]
  quoteLines   QuoteLine[]

  @@index([tenantId])
  @@index([sku])
}

model Quote {
  id        String     @id @default(uuid())
  tenantId  String
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  clientId  String?
  client    Client?    @relation(fields: [clientId], references: [id])
  title     String?
  note      String?
  paymentMethod String?
  quoteDate DateTime?
  dueDate   DateTime?
  number    String
  status    String?
  defaultTaxRate Decimal? @db.Decimal(5, 4)
  subtotal  Decimal    @db.Decimal(12, 2)
  taxAmount Decimal    @db.Decimal(12, 2)
  total     Decimal    @db.Decimal(12, 2)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?

  items     QuoteLine[]

  @@index([tenantId])
  @@index([clientId])
}

model QuoteLine {
  id        String   @id @default(uuid())
  quoteId   String
  quote     Quote    @relation(fields: [quoteId], references: [id])
  articleId String?
  article   Article? @relation(fields: [articleId], references: [id])
  label     String
  quantity  Int
  unitPrice Decimal  @db.Decimal(12, 2)
  lineTotal Decimal  @db.Decimal(12, 2)
  taxRate   Decimal? @db.Decimal(5, 4)
  taxAmount Decimal? @db.Decimal(12, 2)

  @@index([articleId])
}

model Invoice {
  id        String       @id @default(uuid())
  tenantId  String
  tenant    Tenant       @relation(fields: [tenantId], references: [id])
  clientId  String?
  client    Client?      @relation(fields: [clientId], references: [id])
  title     String?
  note      String?
  paymentMethod String?
  invoiceDate DateTime?
  dueDate   DateTime?
  number    String
  status    String?
  defaultTaxRate Decimal? @db.Decimal(5, 4)
  subtotal  Decimal      @db.Decimal(12, 2)
  taxAmount Decimal      @db.Decimal(12, 2)
  total     Decimal      @db.Decimal(12, 2)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  deletedAt DateTime?

  items     InvoiceLine[]
  payments  InvoicePayment[]

  @@index([tenantId])
  @@index([clientId])
}

model InvoiceLine {
  id        String   @id @default(uuid())
  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
  articleId String?
  article   Article? @relation(fields: [articleId], references: [id])
  label     String
  quantity  Int
  unitPrice Decimal  @db.Decimal(12, 2)
  lineTotal Decimal  @db.Decimal(12, 2)
  taxRate   Decimal? @db.Decimal(5, 4)
  taxAmount Decimal? @db.Decimal(12, 2)

  @@index([articleId])
}

model InvoicePayment {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
  amount    Decimal  @db.Decimal(12, 2)
  method    String?
  paidAt    DateTime?
  reference String?
  note      String?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([invoiceId])
}

model Cheque {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id])
  amount    Decimal  @db.Decimal(12, 2)
  status    String?
  dueDate   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([tenantId])
  @@index([clientId])
}

model BillingSubscription {
  id               String              @id @default(uuid())
  tenantId         String              @unique
  tenant           Tenant              @relation(fields: [tenantId], references: [id])
  plan             String
  status           SubscriptionStatus
  currentPeriodEnd DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
}

model BillingSubscriptionHistory {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  plan      String
  status    SubscriptionStatus
  action    String
  note      String?
  createdAt DateTime @default(now())

  @@index([tenantId])
}

model Notification {
  id        String           @id @default(uuid())
  tenantId  String
  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  userId    String?
  user      User?            @relation(fields: [userId], references: [id])
  type      NotificationType
  entityType String?
  entityId  String?
  eventKey  String?
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([isRead])
  @@unique([tenantId, entityType, entityId, eventKey])
}
